---
title: "E3Task"
author: 'Author: Yelu He'
date: "2023-05-10"
output: html_document
---
## Library preparation
```{r setup, echo = FALSE, warning=FALSE, message=FALSE}
## Prepare the library for further use
library(readr)
library(dplyr)
library(ggplot2)
library(sf)
library(terra)
library(lubridate)
library(zoo)
```

## Task 0: Import data and preparation
```{r task0, echo = TRUE, warning = FALSE, message = FALSE}
## Load the data
wildschwein <- read_delim("wildschwein_BE_2056.csv", ",")

## select data of sabi in a specific time range
sabi <- wildschwein %>%
    filter(TierName == "Sabi", DatetimeUTC >= "2015-07-01", DatetimeUTC < "2015-07-03")

## View the map of sabi
sabi_sf <- st_as_sf(sabi, coords = c("E", "N"), crs = 2056, remove = FALSE)
ggplot(sabi_sf, aes(x = sabi_sf$E, 
                    y = sabi$N)) + 
  geom_point() + 
  geom_path()

## Specify a temporal window
## Measure distance from every point to every other point within the temporal window
sabi <- sabi %>%
  mutate(
        nMinus2 = sqrt((lag(E, 2) - E)^2 + (lag(N, 2) - N)^2), # distance to pos -30 minutes
        nMinus1 = sqrt((lag(E, 1) - E)^2 + (lag(N, 1) - N)^2), # distance to pos -15 minutes
        nPlus1  = sqrt((E - lead(E, 1))^2 + (N - lead(N, 1))^2), # distance to pos +15 mintues
        nPlus2  = sqrt((E - lead(E, 2))^2 + (N - lead(N, 2))^2) # distance to pos +30 minutes
    )
sabi <- sabi |>
    rowwise() |>
    mutate(
        stepMean = mean(c(nMinus2, nMinus1, nPlus1, nPlus2))
    ) |>
    ungroup()
sabi

## Remove static points
sabi <- sabi |>
    ungroup() |>
    mutate(static = stepMean < mean(stepMean, na.rm = TRUE))

sabi_filter <- sabi |>
    filter(!static)

sabi_filter |>
    ggplot(aes(E, N)) +
    geom_path() +
    geom_point() +
    coord_fixed() +
    theme(legend.position = "bottom")

# Preparation
## Load the data
move0 <- read_delim("movementdata/yelu_dataset_01.csv", ";")
## Use right coordinate system and preserve original E/N columns
move0 <- st_as_sf(move0, coords = c("Longitude", "Latitude"), crs = 2056, remove = FALSE)
## Select needed columns
move1 <- select(move0, Date, Time, Latitude, Longitude, geometry)
head(move1)
move1_coordinates <- st_coordinates(move1)
move1 <- cbind(move1, move1_coordinates)
move1f <- move1[move1$Date == '25.04.2023',]

```


## Task 1: Segmentation
```{r task1, echo = TRUE, warning = FALSE, message = FALSE}
## View the map of records
ggplot(move1f, 
       aes(x = move1f$X, 
           y = move1f$Y)) +
  geom_point() +
  geom_path()

## Specify a temporal window
## Measure distance from every point to every other point within the temporal window
move1f <- move1f %>%
  mutate(
        nMinus2 = sqrt((lag(X, 2) - X)^2 + (lag(Y, 2) - Y)^2), # distance to pos -30 minutes
        nMinus1 = sqrt((lag(X, 1) - X)^2 + (lag(Y, 1) - Y)^2), # distance to pos -15 minutes
        nPlus1  = sqrt((X - lead(X, 1))^2 + (Y - lead(Y, 1))^2), # distance to pos +15 mintues
        nPlus2  = sqrt((X - lead(X, 2))^2 + (Y - lead(Y, 2))^2) # distance to pos +30 minutes
    )


move1f <- move1f %>%
    rowwise() %>%
    mutate(
        stepMean = mean(c(nMinus2, nMinus1, nPlus1, nPlus2))
    ) %>%
    ungroup()
move1f

## Remove static points
move1f <- move1f |>
    ungroup() |>
    mutate(static = stepMean < mean(stepMean, na.rm = TRUE))

move1f_filter <- move1f %>%
    filter(!static)

ggplot(data = move1f_filter, aes(X, Y)) +
    geom_path() +
    geom_point() +
    # coord_fixed() +
    theme(legend.position = "bottom")

```

## Task 2: Specify and apply threshold d
```{r task2, echo = TRUE, warning = FALSE, message = FALSE}
## Explore the value of stepMean
hist(move1f$stepMean)
boxplot(move1f$stepMean)
summary(move1f$stepMean)
## Use the mean of stepMean values as threshold
d <- mean(move1f$stepMean)
## Set to static column
# move1f <- move1f |>
#     ungroup() |>
#     mutate(static = stepMean < mean(stepMean,
#           na.rm = TRUE))


```

## Task 3: Visualize segmented trajectories
```{r task3, echo = TRUE, warning = FALSE, message = FALSE}
ggplot(data = move1f, aes(X, Y, color = static)) +
    geom_path() +
    geom_point() +
    # coord_equal() +
    theme(legend.position = "right")
```

## Task 4: Segment-based analysis
```{r task4, echo = TRUE, warning = FALSE, message = FALSE}
## Assign segment ID for each segment
rle_id <- function(vec) {
    x <- rle(vec)$lengths
    as.factor(rep(seq_along(x), times = x))
}
## Name it _f1 as _filter1, different from _filter
move1f_f1 <- move1f |>
    mutate(segment_id = rle_id(static))
head(move1f_f1)
## Plot the segments based on segment ID
ggplot(data = move1f_f1, aes(X, Y, color = segment_id)) +
    geom_path() +
    geom_point() + 
    # coord_equal() +
    theme(legend.position = "right", legend.key.size = unit(0.5,'cm'), legend.text = element_text(size = 5))
## Calculate the duration time for each segment
move1f_f1 <- move1f_f1 %>% group_by(segment_id) %>% mutate(duration = max(Time) - min(Time))
## Select the segments which has a duration more than five minutes
move1f_f1_5min <- move1f_f1[move1f_f1$duration >= 300,]
unique(move1f_f1_5min$segment_id)
unique(move1f_f1_5min$duration)

## Plot the segments which has a duration more than 5 minutes
ggplot(data = move1f_f1_5min, aes(X, Y, color = segment_id)) +
    geom_path() +
    geom_point() + 
    # coord_equal() +
    theme(legend.position = "right")

## Plot each segment
idlist <- unique(move1f_f1_5min$segment_id)
move1f_f1_5min_1 <- move1f_f1_5min[move1f_f1_5min$segment_id == idlist[1],]
ggplot(data = move1f_f1_5min_1, aes(X, Y)) +
    geom_path() +
    geom_point() +
    ggtitle("segment id = 11")

move1f_f1_5min_2 <- move1f_f1_5min[move1f_f1_5min$segment_id == idlist[2],]
ggplot(data = move1f_f1_5min_2, aes(X, Y)) +
    geom_path() +
    geom_point() +
    ggtitle("segment id = 27")

move1f_f1_5min_3 <- move1f_f1_5min[move1f_f1_5min$segment_id == idlist[3],]
ggplot(data = move1f_f1_5min_3, aes(X, Y)) +
    geom_path() +
    geom_point() +
    ggtitle("segment id = 30")

move1f_f1_5min_4 <- move1f_f1_5min[move1f_f1_5min$segment_id == idlist[4],]
ggplot(data = move1f_f1_5min_4, aes(X, Y)) +
    geom_path() +
    geom_point() +
    ggtitle("segment id = 52")

move1f_f1_5min_5 <- move1f_f1_5min[move1f_f1_5min$segment_id == idlist[5],]
ggplot(data = move1f_f1_5min_5, aes(X, Y)) +
    geom_path() +
    geom_point() +
    ggtitle("segment id = 62")

move1f_f1_5min_6 <- move1f_f1_5min[move1f_f1_5min$segment_id == idlist[6],]
ggplot(data = move1f_f1_5min_6, aes(X, Y)) +
    geom_path() +
    geom_point() +
    ggtitle("segment id = 73")

```

## Task 5: Similarity measures
```{r task5, echo = TRUE, warning = FALSE, message = FALSE}




```


## Task 6: Calculate similarity
```{r task6, echo = TRUE, warning = FALSE, message = FALSE}



```

